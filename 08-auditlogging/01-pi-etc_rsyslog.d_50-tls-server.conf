# Load the imtcp module for TCP reception
module(load="imtcp"
       StreamDriver.Name="gtls"          # Use the GnuTLS driver for TLS
       StreamDriver.Mode="1"             # Require TLS (full encryption)
       StreamDriver.Authmode="anon"      # Allow anonymous clients (no client cert required from OpenShift)
      )

# Global TLS settings for GTLS driver
global(
    DefaultNetstreamDriver="gtls"
    DefaultNetstreamDriverCAFile="/etc/rsyslog.d/tls_certs/ca.pem"
    DefaultNetstreamDriverCertFile="/etc/rsyslog.d/tls_certs/server-cert.pem"
    DefaultNetstreamDriverKeyFile="/etc/rsyslog.d/tls_certs/server-key.pem"
)

# Input for TLS syslog on standard TLS syslog port (6514)
input(type="imtcp" port="6514")

# Define a template for log format (optional, but good for consistent logs)
template(name="OpenShiftLogFormat" type="string"
         string="%TIMESTAMP:::date-rfc3339% %HOSTNAME% %APP-NAME% %PROCID% %MSG%\n")

# Define a rule to store logs received via TLS to a specific file
if $inputname == "imtcp" then {
    action(type="omfile" file="/var/log/openshift_logs.log" template="OpenShiftLogFormat")
    # Optionally, stop processing to prevent duplication in other log files
    stop
}

